name: 股票异动监控 v2

on:
  schedule:
    # 条件1 盘中实时监控 —— A股/港股交易时段（UTC 01:30-06:55），每5分钟
    - cron: "*/5 1-6 * * 1-5"
    # 条件1 盘中实时监控 —— 美股交易时段（UTC 14:30-20:55），每5分钟
    - cron: "*/5 14-20 * * 1-5"
    # 条件2+3 —— A股收盘后30分钟（15:30 CST = 07:30 UTC）
    - cron: "30 7 * * 1-5"
    # 条件2+3 —— 港股收盘后30分钟（16:30 HKT = 08:30 UTC）
    - cron: "30 8 * * 1-5"
    # 条件2+3 —— 美股收盘后30分钟（16:30 EST = 21:30 UTC）
    - cron: "30 21 * * 1-5"
    # 日报 —— A股收盘后1小时（16:00 CST = 08:00 UTC）
    - cron: "0 8 * * 1-5"
    # 日报 —— 港股收盘后1小时（17:00 HKT = 09:00 UTC）
    - cron: "0 9 * * 1-5"
    # 日报 —— 美股收盘后1小时（17:00 EST = 22:00 UTC）
    - cron: "0 22 * * 1-5"

  workflow_dispatch:
    inputs:
      mode:
        description: "运行模式"
        required: true
        default: "intraday"
        type: choice
        options:
          - intraday
          - close_a
          - close_hk
          - close_us
          - daily_a
          - daily_hk
          - daily_us

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: 缓存 pip 依赖
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: 安装依赖
        run: pip install -r requirements.txt

      - name: 判断运行模式并执行
        env:
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
          MANUAL_MODE: ${{ github.event.inputs.mode }}
        run: |
          # 手动触发时，使用用户指定的模式
          if [ -n "$MANUAL_MODE" ]; then
            echo "手动触发，模式：$MANUAL_MODE"
            python stock_monitor.py $MANUAL_MODE
            exit 0
          fi

          # 定时触发：根据当前 UTC 时间决定模式
          HOUR=$(date -u +"%H")
          MINUTE=$(date -u +"%M")

          echo "当前 UTC 时间：${HOUR}:${MINUTE}"

          if [ "$HOUR" = "07" ] && [ "$MINUTE" = "30" ]; then
            echo "→ A股收盘后检测"
            python stock_monitor.py close_a

          elif [ "$HOUR" = "08" ] && [ "$MINUTE" = "00" ]; then
            echo "→ A股日报"
            python stock_monitor.py daily_a

          elif [ "$HOUR" = "08" ] && [ "$MINUTE" = "30" ]; then
            echo "→ 港股收盘后检测"
            python stock_monitor.py close_hk

          elif [ "$HOUR" = "09" ] && [ "$MINUTE" = "00" ]; then
            echo "→ 港股日报"
            python stock_monitor.py daily_hk

          elif [ "$HOUR" = "21" ] && [ "$MINUTE" = "30" ]; then
            echo "→ 美股收盘后检测"
            python stock_monitor.py close_us

          elif [ "$HOUR" = "22" ] && [ "$MINUTE" = "00" ]; then
            echo "→ 美股日报"
            python stock_monitor.py daily_us

          else
            echo "→ 盘中实时监控"
            python stock_monitor.py intraday
          fi
