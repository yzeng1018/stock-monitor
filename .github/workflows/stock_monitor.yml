name: 股票异动监控 v2

on:
  schedule:
    # A股盘中监控：UTC 01:30-07:00（北京 09:30-15:00），每5分钟整点触发
    - cron: "*/5 1-6 * * 1-5"
    # 港股盘中监控：UTC 01:30-08:00（港股 09:30-16:00），错开2分钟触发
    - cron: "2-59/5 1-7 * * 1-5"
    # 美股盘中监控：UTC 13:30-21:00（EDT/EST 均覆盖），错开4分钟触发
    - cron: "4-59/5 13-20 * * 1-5"
    # 条件2+3 —— A股收盘后30分钟（15:30 CST = 07:30 UTC）
    - cron: "30 7 * * 1-5"
    # 条件2+3 —— 港股收盘后30分钟（16:30 HKT = 08:30 UTC）
    - cron: "30 8 * * 1-5"
    # 条件2+3 —— 美股收盘后30分钟（16:30 EST = 21:30 UTC）
    - cron: "30 21 * * 1-5"
    # 日报 —— A股收盘后1小时（16:00 CST = 08:00 UTC）
    - cron: "0 8 * * 1-5"
    # 日报 —— 港股收盘后1小时（17:00 HKT = 09:00 UTC）
    - cron: "0 9 * * 1-5"
    # 日报 —— 美股收盘后1小时（17:00 EST = 22:00 UTC）
    - cron: "0 22 * * 1-5"

  workflow_dispatch:
    inputs:
      mode:
        description: "运行模式"
        required: true
        default: "intraday_a"
        type: choice
        options:
          - intraday_a
          - intraday_hk
          - intraday_us
          - intraday
          - close_a
          - close_hk
          - close_us
          - daily_a
          - daily_hk
          - daily_us

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: 缓存 pip 依赖
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: 安装依赖
        run: pip install -r requirements.txt

      - name: 判断运行模式并执行
        env:
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          MANUAL_MODE: ${{ github.event.inputs.mode }}
        run: |
          # 手动触发时，使用用户指定的模式
          if [ -n "$MANUAL_MODE" ]; then
            echo "手动触发，模式：$MANUAL_MODE"
            python stock_monitor.py $MANUAL_MODE
            exit 0
          fi

          # 定时触发：根据当前 UTC 时间决定模式
          # 用总分钟数做区间判断，避免 GitHub Actions cron 延迟导致精确匹配失败
          HOUR=$(date -u +"%H")
          MINUTE=$(date -u +"%M")
          MIN_TOTAL=$((10#$HOUR * 60 + 10#$MINUTE))

          echo "当前 UTC 时间：${HOUR}:${MINUTE}（总分钟数：${MIN_TOTAL}）"

          # 07:25-07:59 (445-479) → A股收盘后检测（计划 07:30）
          if [ $MIN_TOTAL -ge 445 ] && [ $MIN_TOTAL -lt 480 ]; then
            echo "→ A股收盘后检测"
            python stock_monitor.py close_a

          # 08:00-08:29 (480-509) → A股日报（计划 08:00）
          elif [ $MIN_TOTAL -ge 480 ] && [ $MIN_TOTAL -lt 510 ]; then
            echo "→ A股日报"
            python stock_monitor.py daily_a

          # 08:30-08:59 (510-539) → 港股收盘后检测（计划 08:30）
          elif [ $MIN_TOTAL -ge 510 ] && [ $MIN_TOTAL -lt 540 ]; then
            echo "→ 港股收盘后检测"
            python stock_monitor.py close_hk

          # 09:00-09:59 (540-599) → 港股日报（计划 09:00）
          elif [ $MIN_TOTAL -ge 540 ] && [ $MIN_TOTAL -lt 600 ]; then
            echo "→ 港股日报"
            python stock_monitor.py daily_hk

          # 21:25-21:59 (1285-1319) → 美股收盘后检测（计划 21:30）
          elif [ $MIN_TOTAL -ge 1285 ] && [ $MIN_TOTAL -lt 1320 ]; then
            echo "→ 美股收盘后检测"
            python stock_monitor.py close_us

          # 22:00-22:59 (1320-1379) → 美股日报（计划 22:00）
          elif [ $MIN_TOTAL -ge 1320 ] && [ $MIN_TOTAL -lt 1380 ]; then
            echo "→ 美股日报"
            python stock_monitor.py daily_us

          else
            # 盘中监控：A股、港股、美股各自独立推送，由 Python 判断是否开盘
            # A股时段：UTC 01:30-07:00（北京 09:30-15:00）
            if [ $MIN_TOTAL -ge 90 ] && [ $MIN_TOTAL -lt 420 ]; then
              echo "→ A股盘中监控"
              python stock_monitor.py intraday_a
            fi
            # 港股时段：UTC 01:30-08:00（港股 09:30-16:00）
            if [ $MIN_TOTAL -ge 90 ] && [ $MIN_TOTAL -lt 480 ]; then
              echo "→ 港股盘中监控"
              python stock_monitor.py intraday_hk
            fi
            # 美股时段：由 Python 通过 SPY marketState 判断是否正式开盘
            if [ $MIN_TOTAL -ge 720 ] && [ $MIN_TOTAL -lt 1320 ]; then
              echo "→ 美股盘中监控"
              python stock_monitor.py intraday_us
            fi
          fi
