name: 股票异动监控 v2

on:
  schedule:
    # A股盘中监控：UTC 01:30-07:00（北京 09:30-15:00），每5分钟整点触发
    - cron: "*/5 1-6 * * 1-5"
    # 港股盘中监控：UTC 01:30-08:00（港股 09:30-16:00），错开2分钟触发
    - cron: "2-59/5 1-7 * * 1-5"
    # 美股盘中监控：UTC 13:30-21:00（EDT/EST 均覆盖），错开4分钟触发
    - cron: "4-59/5 13-20 * * 1-5"
    # 条件2+3 —— A股收盘后30分钟（15:30 CST = 07:30 UTC）
    - cron: "30 7 * * 1-5"
    # 条件2+3 —— 港股收盘后30分钟（16:30 HKT = 08:30 UTC）
    - cron: "30 8 * * 1-5"
    # 条件2+3 —— 美股收盘后30分钟（16:30 EST = 21:30 UTC）
    - cron: "30 21 * * 1-5"
    # 日报 —— A股收盘后1小时（16:00 CST = 08:00 UTC）
    - cron: "0 8 * * 1-5"
    # 日报 —— 港股收盘后1小时（17:00 HKT = 09:00 UTC）
    - cron: "0 9 * * 1-5"
    # 日报 —— 美股收盘后1小时（17:00 EST = 22:00 UTC）
    - cron: "0 22 * * 1-5"

  workflow_dispatch:
    inputs:
      mode:
        description: "运行模式"
        required: true
        default: "intraday_a"
        type: choice
        options:
          - intraday_a
          - intraday_hk
          - intraday_us
          - intraday
          - close_a
          - close_hk
          - close_us
          - daily_a
          - daily_hk
          - daily_us

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: 缓存 pip 依赖
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: 获取今日日期
        id: date
        run: echo "today=$(date -u +%Y-%m-%d)" >> $GITHUB_OUTPUT

      - name: 恢复当日异动去重缓存
        uses: actions/cache@v4
        with:
          path: alerted_today.json
          key: alerted-today-${{ steps.date.outputs.today }}-${{ github.run_id }}
          restore-keys: |
            alerted-today-${{ steps.date.outputs.today }}-
          save-always: true

      - name: 安装依赖
        run: pip install -r requirements.txt

      - name: 判断运行模式并执行
        env:
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          MANUAL_MODE: ${{ github.event.inputs.mode }}
          TRIGGER_SCHEDULE: ${{ github.event.schedule }}
        run: |
          # 手动触发时，使用用户指定的模式
          if [ -n "$MANUAL_MODE" ]; then
            echo "手动触发，模式：$MANUAL_MODE"
            python stock_monitor.py $MANUAL_MODE
            exit 0
          fi

          # 定时触发：直接用触发的 cron 表达式匹配模式，避免时间区间歧义
          echo "触发 cron：$TRIGGER_SCHEDULE"
          case "$TRIGGER_SCHEDULE" in
            "*/5 1-6 * * 1-5")
              echo "→ A股盘中监控"
              python stock_monitor.py intraday_a
              ;;
            "2-59/5 1-7 * * 1-5")
              echo "→ 港股盘中监控"
              python stock_monitor.py intraday_hk
              ;;
            "4-59/5 13-20 * * 1-5")
              echo "→ 美股盘中监控"
              python stock_monitor.py intraday_us
              ;;
            "30 7 * * 1-5")
              echo "→ A股收盘后检测"
              python stock_monitor.py close_a
              ;;
            "30 8 * * 1-5")
              echo "→ 港股收盘后检测"
              python stock_monitor.py close_hk
              ;;
            "30 21 * * 1-5")
              echo "→ 美股收盘后检测"
              python stock_monitor.py close_us
              ;;
            "0 8 * * 1-5")
              echo "→ A股日报"
              python stock_monitor.py daily_a
              ;;
            "0 9 * * 1-5")
              echo "→ 港股日报"
              python stock_monitor.py daily_hk
              ;;
            "0 22 * * 1-5")
              echo "→ 美股日报"
              python stock_monitor.py daily_us
              ;;
            *)
              echo "未知触发 cron：$TRIGGER_SCHEDULE"
              exit 1
              ;;
          esac
