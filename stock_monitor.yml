name: 股票异动监控

on:
  schedule:
    # 美股交易时间（UTC）：14:30-21:00，每15分钟检查一次
    - cron: "*/15 14-21 * * 1-5"
    # A股/港股交易时间（UTC）：01:30-07:00，每15分钟检查一次
    - cron: "*/15 1-7 * * 1-5"
    # 每天收盘后发送日报（美股收盘 21:30 UTC）
    - cron: "30 21 * * 1-5"
  workflow_dispatch:  # 允许手动触发

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: 安装依赖
        run: pip install -r requirements.txt
      
      - name: 判断运行模式并执行
        env:
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
        run: |
          # 获取当前 UTC 分钟
          MINUTE=$(date -u +"%M")
          HOUR=$(date -u +"%H")
          
          # 21:30 UTC 发送日报，其他时间检测异动
          if [ "$HOUR" = "21" ] && [ "$MINUTE" = "30" ]; then
            echo "发送每日汇总..."
            python stock_monitor.py summary
          else
            echo "检测异动..."
            python stock_monitor.py alert
          fi
